{% extends "layouts/base.html" %}

{% block title %}Create Quiz{% endblock %}

{% block content %}
<div class="content">
  <div class="row">
    <div class="col-md-12">
      <!-- Generate Excel Template Card -->
      <div class="card">
        <div class="card-header">
          <h4 class="card-title">ðŸ“„ Generate Quiz Excel Template</h4>
        </div>
        <div class="card-body">
          <form method="POST">
            {% csrf_token %}
         
            <div class="form-group">
              <label for="num_questions">Number of Questions</label>
              
              <input type="number" id="num_questions" name="num_questions" class="form-control" min="1" required>
            </div>
            <button type="submit" class="btn btn-primary btn-fill">Generate Excel</button>
          </form>
        </div>
      </div>
    </div>
  </div>
 
  {% if filename %}
  <div class="row">
    <div class="col-md-12">
      <!-- Download File Card -->
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">âœ… Your quiz file is ready!</h5>
          <form method="GET" action="{% url 'download_quiz_file' %}">
            <input type="hidden" name="filename" value="{{ filename }}">
            <button type="submit" class="btn btn-success btn-fill">Download your file</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Upload Excel File Section -->
  <div class="row mt-4">
    <div class="col-md-4 offset-md-4">
      <div class="card">
        <div class="card-header text-center">
          <h4 class="card-title">ðŸ“¤ Upload Quiz Excel File</h4>
        </div>
        <div class="card-body">
          <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="form-group">
              <label for="quiz_file">Choose Excel File (.xlsx)</label>
              <div class="input-group mb-3">
                <div class="input-group-prepend">
                  <span class="input-group-text"><i class="fa fa-paperclip"></i></span>
                </div>
                <div class="custom-file">
                  <input type="file" class="custom-file-input" id="quiz_file" name="quiz_file" accept=".xlsx" required onchange="updateFileName()">
                  <label class="custom-file-label" for="quiz_file" id="file_label">Choose file</label>
                </div>
              </div>
            </div>
            <button type="submit" name="upload_excel" class="btn btn-info btn-fill">Upload Excel</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    function updateFileName() {
      const fileInput = document.getElementById('quiz_file');
      const fileLabel = document.getElementById('file_label');
      if (fileInput.files.length > 0) {
        fileLabel.textContent = fileInput.files[0].name;
      } else {
        fileLabel.textContent = 'Choose file';
      }
    }
  </script>

  {% if upload_success %}
  <div class="row">
    <div class="col-md-12">
      <div class="card">
        <div class="card-body">
          <h5>âœ… File uploaded successfully!</h5>
          <p>Saved at: <code>{{ uploaded_path }}</code></p>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  {% if script_output %}
  <!-- Display AI-generated Questions -->
  <div class="row mt-4">
    <div class="col-md-12">
      
      <div class="card">
        <div class="card-header">
          <h4 class="card-title">ðŸ§  Your Imported Questions From Excel File</h4>
          <!-- Render only the 'quiz' field from the QuestionForm -->
          <label class="block mb-2">Select Quiz:</label>
          <div style="width: 33%; display: inline-block;">
            {{ question_form.quiz }} <!-- This will render the 'quiz' dropdown field -->
          </div>
          <label class="d-block mt-3">Please review your questions. If all is good, select your quiz from the dropdown and save to the database.</label>
          <button type="submit" class="btn btn-success btn-fill mt-2">Save to Database</button>
        </div>
        <div class="card-body">
          <ul class="list-group">
            {% for question in script_output %}
            <li class="list-group-item mb-4">
              <h5><strong>Question {{ forloop.counter }}:</strong> {{ question.question }}</h5>

              <p><strong>Options:</strong></p>
              <ul>
                {% for key, value in question.options.items %}
                <li><strong>{{ key }}:</strong> {{ value }}</li>
                {% endfor %}
              </ul>

              <p><strong>Correct Answer:</strong> {{ question.correct_answer }}</p>

              <p><strong>Explanation:</strong> {{ question.explanation }}</p>

              <p><strong>Example:</strong></p>
              <pre>{{ question.example }}</pre>

              <p><strong>Why Not (for other options):</strong></p>
              <ul>
                {% for key, reason in question.why_not.items %}
                <li><strong>{{ key }}:</strong> {{ reason }}</li>
                {% endfor %}
              </ul>
            </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>
  {% else %}
  <div class="row">
    <div class="col-md-12 text-center">
      <p>No questions to display.</p>
    </div>
  </div>
  {% endif %}
</div>
{% endblock content %}
